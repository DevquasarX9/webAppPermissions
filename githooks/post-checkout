#!/bin/sh
PHP_VERSION=$(head -1 .phprc)

# This hook is called with the following parameters:
# $1 - The name of the file containing the SHA-1 of the commit before the checkout
# $2 - The name of the file containing the SHA-1 of the commit after the checkout
# $3 - A flag indicating whether the checkout was a branch or file checkout

isBranchCheckout=1

if [ $3 -eq $isBranchCheckout ]; then
    echo "[$(date '+%H:%M:%S')] Checking for dependency changes..."

    # Check if composer dependencies changed
    if git diff --name-only $1 $2 | grep -E "^(composer\.json|composer\.lock)$" > /dev/null; then
        echo "[$(date '+%H:%M:%S')] Running composer install..."
        $PHP_VERSION /usr/local/bin/composer install --no-interaction
        if [ $? -ne 0 ]; then
            echo "[$(date '+%H:%M:%S')] Error: composer install failed"
            exit 1
        fi
    else
        echo "[$(date '+%H:%M:%S')] Skipping composer install - no changes detected"
    fi
fi

if [ -f ./.git/hooks/post-checkout ]; then
	./.git/hooks/post-checkout $@
fi
